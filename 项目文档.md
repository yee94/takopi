# yee88 项目文档

## 项目概述

**yee88** 是一个 Telegram 桥接工具，用于将 AI 编码助手（Codex、Claude Code、OpenCode、Pi）连接到 Telegram 聊天界面。用户可以通过 Telegram 发送任务指令，实时查看执行进度，并在终端中继续对话。

---

## 基本信息

| 属性 | 值 |
|------|-----|
| **项目名称** | yee88 |
| **版本** | v0.3.0 |
| **作者** | yee.wang |
| **许可证** | MIT |
| **Python 版本** | >= 3.14 |
| **主页** | https://github.com/banteg/yee88 |
| **文档** | https://yee88.dev/ |

---

## 核心功能

### 1. 多引擎支持
- **Codex** - OpenAI 的代码助手
- **Claude** - Anthropic 的 Claude Code
- **OpenCode** - OpenCode CLI
- **Pi** - Pi 代理

### 2. 工作模式

#### Assistant 模式（助手模式）
- 持续对话，新消息自动继续
- 使用 `/new` 重置对话
- 适合：个人工作、自然对话流程

#### Workspace 模式（工作区模式）
- 论坛主题绑定到项目和分支
- 适合：团队协作、多仓库工作流

#### Handoff 模式（交接模式）
- 回复继续对话
- 可复制恢复行到终端
- 适合：明确控制、终端优先工作流

### 3. 项目管理
- **项目注册**: `yee88 init <alias>`
- **分支工作树**: 使用 `@branch` 在专用工作树中运行
- **上下文保持**: 回复保留 `ctx: project @branch` 页脚

### 4. 核心特性
- ✅ 多仓库/分支并行工作（Git 工作树）
- ✅ 无状态恢复（聊天或终端均可继续）
- ✅ 实时进度流（命令、工具、文件变更、耗时）
- ✅ 跨代理会话并行运行
- ✅ Telegram 功能支持（语音消息、定时消息）
- ✅ 文件传输（发送文件到仓库或取回）
- ✅ 群组聊天和主题支持

---

## 系统架构

### 核心组件

```
┌─────────────────────────────────────────────────────────────┐
│                        Telegram Bot                         │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                      Bridge（桥接层）                        │
│  - 接收 Telegram 更新                                       │
│  - 解析恢复令牌                                              │
│  - 调度运行                                                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                    Runner（运行器）                          │
│  - 执行引擎进程                                              │
│  - 生成 Takopi 事件                                          │
│  - 支持：codex, claude, opencode, pi                         │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                    Renderer（渲染器）                        │
│  - 将事件渲染为 Telegram Markdown                            │
│  - 处理进度消息和最终消息                                     │
└─────────────────────────────────────────────────────────────┘
```

### 标准化事件模型 (TakopiEvent)

| 事件类型 | 说明 |
|---------|------|
| `started` | 运行开始，包含恢复令牌 |
| `action` | 动作事件（命令、工具、文件变更等） |
| `completed` | 运行完成，包含最终答案 |

### 动作类型 (Action Kinds)

- `command` - 命令执行
- `tool` - 工具调用
- `file_change` - 文件变更
- `web_search` - 网络搜索
- `subagent` - 子代理
- `turn` - 对话轮次
- `warning` - 警告
- `telemetry` - 遥测数据
- `note` - 备注

---

## 技术规范

### 恢复令牌 (ResumeToken)

```python
@dataclass(frozen=True, slots=True)
class ResumeToken:
    engine: str  # 引擎标识符
    value: str   # 令牌值
```

### 恢复行格式

- **Codex**: `codex resume <id>`
- **Claude**: `claude --resume <id>`
- **Pi**: `pi --session <token>`

### 并发控制

- **线程键**: `ThreadKey(resume) = f"{resume.engine}:{resume.value}"`
- **同一线程串行**: 相同 ThreadKey 的任务排队执行
- **不同线程并行**: 不同 ThreadKey 的任务可并行运行

---

## 安装与使用

### 安装要求

- `uv` 包管理器 (`curl -LsSf https://astral.sh/uv/install.sh | sh`)
- Python 3.14+ (`uv python install 3.14`)
- 至少一个引擎在 PATH 中: `codex`, `claude`, `opencode`, 或 `pi`

### 安装命令

```bash
uv tool install -U yee88
```

### 首次运行

```bash
# 启动设置向导
yee88

# 或在任意 Git 仓库中
yee88 topic init
yee88
```

### 基本使用

```bash
# 进入项目目录
cd ~/your-project
yee88
```

在 Telegram 中发送消息给机器人：
- 使用 `/codex`, `/claude`, `/opencode`, `/pi` 前缀选择引擎
- 回复消息继续对话

### 项目管理

```bash
# 注册项目
yee88 init happy-gadgets

# 从任意位置定位项目
/happy-gadgets hard reset the timeline

# 在分支上运行（专用工作树）
/happy-gadgets @feat/memory-box freeze artifacts forever
```

### 配置管理

```bash
# 查看配置
yee88 config list

# 获取配置项
yee88 config get <key>

# 设置配置项
yee88 config set <key> <value>
```

---

## 项目结构

```
yee88/
├── src/yee88/                    # 源代码
│   ├── cli/                      # CLI 命令
│   │   ├── __init__.py
│   │   ├── config.py             # 配置命令
│   │   ├── doctor.py             # 诊断工具
│   │   ├── init.py               # 项目初始化
│   │   ├── onboarding_cmd.py     # 引导命令
│   │   ├── plugins.py            # 插件管理
│   │   ├── run.py                # 运行命令
│   │   └── topic.py              # 主题管理
│   ├── runners/                  # 引擎运行器
│   │   ├── codex.py              # Codex 运行器
│   │   ├── claude.py             # Claude 运行器
│   │   ├── opencode.py           # OpenCode 运行器
│   │   ├── pi.py                 # Pi 运行器
│   │   └── ...
│   ├── telegram/                 # Telegram 集成
│   │   ├── backend.py            # 后端适配器
│   │   ├── bridge.py             # 桥接实现
│   │   ├── client.py             # 客户端 API
│   │   ├── commands/             # 命令处理
│   │   └── ...
│   ├── schemas/                  # 数据模式
│   └── ...
├── docs/                         # 文档
│   ├── tutorials/                # 教程
│   ├── how-to/                   # 操作指南
│   ├── reference/                # 参考文档
│   └── explanation/              # 解释说明
├── tests/                        # 测试
├── pyproject.toml                # 项目配置
├── changelog.md                  # 变更日志
└── readme.md                     # 项目说明
```

---

## 依赖项

### 核心依赖

| 包名 | 版本 | 用途 |
|------|------|------|
| anyio | >=4.12.0 | 异步运行时 |
| httpx | >=0.28.1 | HTTP 客户端 |
| markdown-it-py | - | Markdown 解析 |
| msgspec | >=0.20.0 | 高性能序列化 |
| openai | >=2.15.0 | OpenAI API |
| pydantic | >=2.12.5 | 数据验证 |
| pydantic-settings | >=2.12.0 | 配置管理 |
| questionary | >=2.1.1 | 交互式提示 |
| rich | >=14.2.0 | 终端美化 |
| structlog | >=25.5.0 | 结构化日志 |
| sulguk | >=0.11.1 | Telegram 渲染 |
| tomli-w | >=1.2.0 | TOML 写入 |
| typer | >=0.21.0 | CLI 框架 |
| watchfiles | >=0.21.0 | 文件监控 |

### 开发依赖

- pytest (>=9.0.2) - 测试框架
- pytest-cov (>=7.0.0) - 覆盖率
- ruff (>=0.14.10) - 代码检查
- mutmut (>=3.4.0) - 变异测试

---

## 版本历史

### v0.2.0 (2026-01-30)
- 更新启动消息

### v0.21.4 (2026-01-22)
- 添加 Telegram 用户白名单控制

### v0.21.3 (2026-01-21)
- 修复 Telegram 主题根回复问题

### v0.21.2 (2026-01-20)
- 修复工作目录变更时清除聊天会话

### v0.21.1 (2026-01-18)
- 分离 Telegram 语音转录客户端
- 默认禁用 Telegram 链接预览

### v0.21.0 (2026-01-16)
- 添加 `yee88 config` 子命令
- 改进 Telegram 命令规划和可测试性
- 重构 Telegram 模式和解析

### v0.20.0 (2026-01-15)
- 添加 Telegram 仅提及触发模式
- 添加 `/model` 和 `/reasoning` 覆盖命令
- 合并转发的 Telegram 消息

### v0.19.0 (2026-01-15)
- 基于角色的设置流程改进引导
- 添加队列取消占位符

### v0.18.0 (2026-01-13)
- 添加每聊天和每主题默认代理
- 添加 Pi 运行器会话恢复简写

### v0.17.0 (2026-01-12)
- 添加聊天会话模式（自动恢复）
- 添加消息溢出分割选项
- 添加 `show_resume_line` 选项

### v0.16.0 (2026-01-12)
- 加强 Telegram 文件传输处理

### v0.15.0 (2026-01-11)
- 添加 Telegram 文件传输支持

### v0.14.0 (2026-01-10)
- 添加 Telegram 论坛主题支持
- 添加内联取消按钮
- 添加配置热重载

### v0.13.0 (2026-01-09)
- 添加每项目聊天路由

### v0.12.0 (2026-01-09)
- 添加 Telegram 语音消息转录

### v0.11.0 (2026-01-08)
- 添加基于入口点的插件系统

### v0.10.0 (2026-01-08)
- 添加传输注册表
- 迁移配置加载到 pydantic-settings

### v0.9.0 (2026-01-07)
- 项目和功能分支工作树支持
- 传输/呈现器协议

### v0.8.0 (2026-01-05)
- Telegram 请求队列和速率限制

### v0.7.0 (2026-01-04)
- 迁移日志到 structlog
- 添加 msgspec 模式

### v0.6.0 (2026-01-03)
- 交互式引导
- 锁文件防止多实例竞争

### v0.5.0 (2026-01-02)
- 添加 OpenCode 运行器
- 添加 Pi 运行器

### v0.4.0 (2026-01-02)
- 添加自动路由引擎选择
- 添加 `/cancel` 命令

### v0.3.0 (2026-01-01)
- 添加 Claude Code 运行器
- 自动发现引擎后端

### v0.2.0 (2025-12-31)
- 引入运行器协议
- 标准化事件模型
- 每线程作业队列

### v0.1.0 (2025-12-29)
- 初始版本
- Telegram 机器人桥接 OpenAI Codex CLI
- 无状态会话恢复
- 实时进度更新

---

## 插件系统

yee88 支持基于入口点的插件，用于引擎、传输和命令。

### 插件类型

1. **引擎后端** (`yee88.engine_backends`)
2. **传输后端** (`yee88.transport_backends`)
3. **命令插件**

### 已知插件

- **yee88-slack** - Slack 集成
- **yee88-discord** - Discord 集成
- **yee88-scripts** - 脚本管理

---

## 测试要求

测试覆盖率要求：**>= 81%**

### 测试覆盖范围

1. **运行器合约**
   - 令牌获取时恰好一个 `started`
   - 动作模式有效性
   - 事件顺序保持
   - `completed` 事件作为最后一个事件

2. **运行器串行化**
   - 相同恢复令牌的并发运行串行化
   - `resume=None` 运行获取每线程锁

3. **桥接每线程调度**
   - 每 ThreadKey 的 FIFO
   - 同一线程的第二个作业等待第一个完成

4. **进度节流**
   - 编辑频率不超过配置间隔
   - 内容未更改时不编辑
   - 截断时保留恢复行

5. **取消**
   - `/cancel` 终止运行并生成"已取消"
   - 如已知则包含恢复行

6. **渲染器格式化**
   - 仅完成动作正确渲染
   - 相同 Action.id 的事件正确折叠

7. **自动路由引擎选择**
   - 非默认引擎的恢复行正确检测和路由
   - 新线程使用配置的默认引擎

---

## 配置说明

### 配置文件位置

- **默认**: `~/.yee88/yee88.toml`
- **锁文件**: `~/.yee88/yee88.lock`

### 主要配置项

```toml
[transports.telegram]
bot_token = "your-bot-token"
chat_id = "your-chat-id"

[engines]
default = "codex"

[codex]
profile = "default"

[claude]
allowed_tools = ["Bash", "Read", "Edit", "Write"]
```

### 会话模式

- `session_mode = "chat"` - 自动恢复每聊天会话
- `session_mode = "handoff"` - 回复继续（默认）

### 消息溢出处理

- `message_overflow = "trim"` - 截断长消息（默认）
- `message_overflow = "split"` - 分割为多条消息

---

## 命令参考

### CLI 命令

| 命令 | 说明 |
|------|------|
| `yee88` | 启动交互式引导或运行桥接 |
| `yee88 --onboard` | 重新运行引导 |
| `yee88 init <alias>` | 注册项目 |
| `yee88 topic init` | 初始化主题 |
| `yee88 config list` | 列出配置 |
| `yee88 config get <key>` | 获取配置项 |
| `yee88 config set <key> <value>` | 设置配置项 |
| `yee88 plugins` | 列出插件 |
| `yee88 transports` | 列出传输 |

### Telegram 命令

| 命令 | 说明 |
|------|------|
| `/cancel` | 取消当前运行 |
| `/new` | 开始新对话 |
| `/ctx` | 查看/更新绑定 |
| `/topic` | 主题管理 |
| `/agent set` | 设置默认代理 |
| `/model` | 模型覆盖 |
| `/reasoning` | 推理覆盖 |
| `/{engine}` | 选择引擎（如 `/claude`） |
| `/{project}` | 定位项目（如 `/myproject`） |

---

## 开发文档

### 开发设置

参见 `docs/how-to/dev-setup.md`

### 架构说明

参见 `docs/explanation/architecture.md`

### 插件开发

参见 `docs/how-to/write-a-plugin.md` 和 `docs/reference/plugin-api.md`

### 规范文档

参见 `docs/reference/specification.md`

---

## 许可证

MIT License - 参见 LICENSE 文件

---

*文档生成时间: 2026-01-31*
*基于 yee88 v0.3.0*
